{% extends 'base_admin.html.twig' %}

{% block title %}Message #{{ message.id }} - Admin TOUTLUX{% endblock %}

{% block page_title %}
    <i class="fas fa-envelope-open"></i> Détails du message
{% endblock %}

{% block breadcrumb %}
    <ol class="breadcrumb float-sm-right">
        <li class="breadcrumb-item"><a href="{{ path('admin_dashboard') }}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{{ path('admin_message_index') }}">Messages</a></li>
        <li class="breadcrumb-item active">Message #{{ message.id }}</li>
    </ol>
{% endblock %}

{% block content %}
    <div class="row">
        <!-- Message principal -->
        <div class="col-md-8">
            <div class="card {% if message.status.value == 'PENDING' %}card-warning{% elseif message.status.value == 'REJECTED' %}card-danger{% else %}card-primary{% endif %}">
                <div class="card-header">
                    <h3 class="card-title">Message</h3>
                    <div class="card-tools">
                        {% if message.status.value == 'PENDING' %}
                            <span class="badge badge-warning">En attente</span>
                        {% elseif message.status.value == 'APPROVED' %}
                            <span class="badge badge-success">Approuvé</span>
                        {% elseif message.status.value == 'REJECTED' %}
                            <span class="badge badge-danger">Rejeté</span>
                        {% else %}
                            <span class="badge badge-info">{{ message.status.value }}</span>
                        {% endif %}
                    </div>
                </div>

                <div class="card-body">
                    <!-- En-tête du message -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>De :</strong>
                            <div class="d-flex align-items-center mt-1">
                                {% if message.sender.avatarName %}
                                    <img src="{{ asset('uploads/avatars/' ~ message.sender.avatarName) }}"
                                         alt="{{ message.sender.fullName }}"
                                         class="img-circle img-size-50 mr-2">
                                {% elseif message.sender.avatar %}
                                    <img src="{{ message.sender.avatar }}"
                                         alt="{{ message.sender.fullName }}"
                                         class="img-circle img-size-50 mr-2">
                                {% else %}
                                    <div class="img-circle img-size-50 mr-2 bg-secondary d-flex align-items-center justify-content-center">
                                        <i class="fas fa-user"></i>
                                    </div>
                                {% endif %}
                                <div>
                                    <a href="{{ path('admin_user_show', {'id': message.sender.id}) }}">
                                        {{ message.sender.fullName }}
                                    </a>
                                    <br>
                                    <small class="text-muted">{{ message.sender.email }}</small>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <strong>À :</strong>
                            {% if message.recipient %}
                                <div class="d-flex align-items-center mt-1">
                                    {% if message.recipient.avatarName %}
                                        <img src="{{ asset('uploads/avatars/' ~ message.recipient.avatarName) }}"
                                             alt="{{ message.recipient.fullName }}"
                                             class="img-circle img-size-50 mr-2">
                                    {% elseif message.recipient.avatar %}
                                        <img src="{{ message.recipient.avatar }}"
                                             alt="{{ message.recipient.fullName }}"
                                             class="img-circle img-size-50 mr-2">
                                    {% else %}
                                        <div class="img-circle img-size-50 mr-2 bg-secondary d-flex align-items-center justify-content-center">
                                            <i class="fas fa-user"></i>
                                        </div>
                                    {% endif %}
                                    <div>
                                        <a href="{{ path('admin_user_show', {'id': message.recipient.id}) }}">
                                            {{ message.recipient.fullName }}
                                        </a>
                                        <br>
                                        <small class="text-muted">{{ message.recipient.email }}</small>
                                    </div>
                                </div>
                            {% else %}
                                <p class="text-muted mt-1">Message général</p>
                            {% endif %}
                        </div>
                    </div>

                    <hr>

                    <!-- Sujet du message -->
                    {% if message.subject %}
                        <div class="mb-3">
                            <strong>Sujet :</strong>
                            <p class="text-primary">{{ message.subject }}</p>
                        </div>
                    {% endif %}

                    <!-- Contenu du message -->
                    <div class="message-content">
                        <h5>Contenu du message :</h5>
                        <div class="border rounded p-3 mb-3" style="background-color: #f8f9fa;">
                            <p style="white-space: pre-wrap;">{{ message.content }}</p>
                        </div>

                        {% if message.originalContent and message.originalContent != message.content %}
                            <h5>Contenu original :</h5>
                            <div class="border rounded p-3 mb-3" style="background-color: #fff3cd;">
                                <p style="white-space: pre-wrap;">{{ message.originalContent }}</p>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Actions de modération -->
                    {% if message.status.value == 'PENDING' %}
                        <hr>
                        <div class="row">
                            <div class="col-md-12">
                                <h5>Actions de modération</h5>
                                <div class="form-group">
                                    <label>Modifier le message (optionnel) :</label>
                                    <textarea class="form-control" id="modifiedContent" rows="4">{{ message.content }}</textarea>
                                </div>

                                <div class="btn-group btn-block">
                                    <button class="btn btn-success" id="approveMessage">
                                        <i class="fas fa-check"></i> Approuver
                                    </button>
                                    <button class="btn btn-warning" id="approveWithModification">
                                        <i class="fas fa-edit"></i> Approuver avec modification
                                    </button>
                                    <button class="btn btn-danger" id="rejectMessage">
                                        <i class="fas fa-times"></i> Rejeter
                                    </button>
                                </div>

                                <div class="form-group mt-2" id="rejectionReasonDiv" style="display: none;">
                                    <label>Raison du rejet :</label>
                                    <input type="text" class="form-control" id="rejectionReason"
                                           placeholder="Optionnel">
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Historique de la conversation -->
            {% if conversationHistory|default([])|length > 1 %}
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Historique de la conversation</h3>
                    </div>
                    <div class="card-body">
                        <div class="direct-chat-messages" style="height: 400px;">
                            {% for msg in conversationHistory %}
                                <div class="direct-chat-msg {% if msg.sender.id == message.sender.id %}{% else %}right{% endif %}">
                                    <div class="direct-chat-infos clearfix">
                                        <span class="direct-chat-name {% if msg.sender.id == message.sender.id %}float-left{% else %}float-right{% endif %}">
                                            {{ msg.sender.fullName }}
                                        </span>
                                        <span class="direct-chat-timestamp {% if msg.sender.id == message.sender.id %}float-right{% else %}float-left{% endif %}">
                                            {{ msg.createdAt|date('d/m/Y H:i') }}
                                        </span>
                                    </div>
                                    {% if msg.sender.avatarName %}
                                        <img class="direct-chat-img"
                                             src="{{ asset('uploads/avatars/' ~ msg.sender.avatarName) }}"
                                             alt="{{ msg.sender.fullName }}">
                                    {% elseif msg.sender.avatar %}
                                        <img class="direct-chat-img"
                                             src="{{ msg.sender.avatar }}"
                                             alt="{{ msg.sender.fullName }}">
                                    {% else %}
                                        <img class="direct-chat-img"
                                             src="{{ asset('dist/img/avatar.png') }}"
                                             alt="{{ msg.sender.fullName }}">
                                    {% endif %}
                                    <div class="direct-chat-text {% if msg.id == message.id %}bg-warning{% endif %}">
                                        {{ msg.originalContent|default(msg.content) }}
                                        {% if msg.status.value == 'REJECTED' %}
                                            <br><small class="text-danger"><i class="fas fa-times-circle"></i> Rejeté</small>
                                        {% elseif msg.editedByModerator %}
                                            <br><small class="text-info"><i class="fas fa-edit"></i> Modifié</small>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Sidebar informations -->
        <div class="col-md-4">
            <!-- Informations sur le message -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Informations</h3>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th>ID :</th>
                            <td>{{ message.id }}</td>
                        </tr>
                        <tr>
                            <th>Envoyé le :</th>
                            <td>{{ message.createdAt|date('d/m/Y à H:i:s') }}</td>
                        </tr>
                        {% if message.property %}
                            <tr>
                                <th>Propriété :</th>
                                <td>
                                    <a href="{{ path('admin_property_show', {'id': message.property.id}) }}">
                                        {{ message.property.title }}
                                    </a>
                                </td>
                            </tr>
                        {% endif %}
                        <tr>
                            <th>Type :</th>
                            <td>
                                {% if message.property %}
                                    <span class="badge badge-info">Message propriété</span>
                                {% else %}
                                    <span class="badge badge-secondary">Message direct</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Lu par destinataire :</th>
                            <td>
                                {% if message.readAt %}
                                    <i class="fas fa-check text-success"></i>
                                    {{ message.readAt|date('d/m/Y H:i') }}
                                {% else %}
                                    <i class="fas fa-times text-danger"></i> Non lu
                                {% endif %}
                            </td>
                        </tr>
                    </table>

                    {% if message.moderatedBy %}
                        <hr>
                        <h5>Modération</h5>
                        <table class="table table-sm">
                            <tr>
                                <th>Modéré par :</th>
                                <td>
                                    <a href="{{ path('admin_user_show', {'id': message.moderatedBy.id}) }}">
                                        {{ message.moderatedBy.fullName }}
                                    </a>
                                </td>
                            </tr>
                            <tr>
                                <th>Date :</th>
                                <td>{{ message.moderatedAt|date('d/m/Y H:i') }}</td>
                            </tr>
                            {% if message.moderationReason %}
                                <tr>
                                    <th>Raison :</th>
                                    <td>{{ message.moderationReason }}</td>
                                </tr>
                            {% endif %}
                            {% if message.adminNote %}
                                <tr>
                                    <th>Note admin :</th>
                                    <td>{{ message.adminNote }}</td>
                                </tr>
                            {% endif %}
                        </table>
                    {% endif %}
                </div>
            </div>

            <!-- Analyse du contenu -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Analyse du contenu</h3>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li>
                            {% if contentAnalysis.hasPhone %}
                                <i class="fas fa-phone text-warning"></i> Contient un numéro de téléphone
                            {% else %}
                                <i class="fas fa-phone text-muted"></i> Pas de numéro de téléphone
                            {% endif %}
                        </li>
                        <li>
                            {% if contentAnalysis.hasEmail %}
                                <i class="fas fa-envelope text-warning"></i> Contient une adresse email
                            {% else %}
                                <i class="fas fa-envelope text-muted"></i> Pas d'adresse email
                            {% endif %}
                        </li>
                        <li>
                            {% if contentAnalysis.hasUrl %}
                                <i class="fas fa-link text-warning"></i> Contient une URL
                            {% else %}
                                <i class="fas fa-link text-muted"></i> Pas d'URL
                            {% endif %}
                        </li>
                        <li>
                            <i class="fas fa-font text-info"></i> {{ contentAnalysis.wordCount }} mots
                        </li>
                        <li>
                            <i class="fas fa-text-width text-info"></i> {{ contentAnalysis.charCount }} caractères
                        </li>
                    </ul>

                    {% if contentAnalysis.hasPhone or contentAnalysis.hasEmail or contentAnalysis.hasUrl %}
                        <div class="alert alert-warning alert-sm">
                            <i class="fas fa-exclamation-triangle"></i>
                            Ce message contient des informations de contact
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Actions rapides -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Actions</h3>
                </div>
                <div class="card-body">
                    <a href="{{ path('admin_message_index') }}" class="btn btn-default btn-block">
                        <i class="fas fa-arrow-left"></i> Retour à la liste
                    </a>

                    {% if message.status.value == 'PENDING' %}
                        <a href="{{ path('admin_message_pending') }}" class="btn btn-warning btn-block">
                            <i class="fas fa-gavel"></i> Voir tous les messages en attente
                        </a>
                    {% endif %}

                    {% if not message.isRead %}
                        <button class="btn btn-info btn-block" id="markAsReadBtn">
                            <i class="fas fa-eye"></i> Marquer comme lu
                        </button>
                    {% endif %}

                    <button class="btn btn-danger btn-block" id="deleteMessage">
                        <i class="fas fa-trash"></i> Supprimer le message
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_javascripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Fonction pour afficher les notifications
            function showNotification(type, message) {
                var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
                var icon = type === 'success' ? 'fa-check' : 'fa-exclamation-triangle';

                // Supprimer les anciennes notifications
                document.querySelectorAll('.notification-alert').forEach(function(el) {
                    el.remove();
                });

                var notification = document.createElement('div');
                notification.className = 'alert ' + alertClass + ' alert-dismissible fade show notification-alert';
                notification.innerHTML = '<i class="fas ' + icon + ' mr-2"></i>' + message +
                    '<button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>';

                var content = document.querySelector('.content');
                content.insertBefore(notification, content.firstChild);

                // Auto-remove après 5 secondes
                setTimeout(function() {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 5000);
            }

            // Modération du message
            var approveBtn = document.getElementById('approveMessage');
            if (approveBtn) {
                approveBtn.addEventListener('click', function() {
                    moderateMessage('approve');
                });
            }

            var approveWithModBtn = document.getElementById('approveWithModification');
            if (approveWithModBtn) {
                approveWithModBtn.addEventListener('click', function() {
                    var modifiedContent = document.getElementById('modifiedContent').value;
                    var originalContent = '{{ message.content|e('js') }}';

                    if (modifiedContent !== originalContent) {
                        moderateMessage('approve', modifiedContent);
                    } else {
                        alert('Veuillez modifier le contenu avant d\'approuver avec modification');
                    }
                });
            }

            var rejectBtn = document.getElementById('rejectMessage');
            if (rejectBtn) {
                rejectBtn.addEventListener('click', function() {
                    var reasonDiv = document.getElementById('rejectionReasonDiv');
                    reasonDiv.style.display = 'block';
                    this.textContent = 'Confirmer le rejet';

                    // Remplacer l'événement
                    var newBtn = this.cloneNode(true);
                    this.parentNode.replaceChild(newBtn, this);

                    newBtn.addEventListener('click', function() {
                        var reason = document.getElementById('rejectionReason').value;
                        moderateMessage('reject', null, reason);
                    });
                });
            }

            function moderateMessage(action, modifiedContent = null, reason = null) {
                var data = {
                    id: {{ message.id }},
                    action: action,
                    modifiedContent: modifiedContent,
                    reason: reason,
                    _token: '{{ csrf_token('moderate_message') }}'
                };

                fetch('{{ path('admin_message_approve', {id: message.id}) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(data)
                })
                    .then(function(response) {
                        return response.json();
                    })
                    .then(function(result) {
                        if (result.success) {
                            showNotification('success', result.message);
                            setTimeout(function() {
                                window.location.href = '{{ path('admin_message_index') }}';
                            }, 1500);
                        } else {
                            showNotification('error', result.error || 'Une erreur est survenue');
                        }
                    })
                    .catch(function(error) {
                        showNotification('error', 'Erreur de connexion');
                    });
            }

            // Marquer comme lu
            var markAsReadBtn = document.getElementById('markAsReadBtn');
            if (markAsReadBtn) {
                markAsReadBtn.addEventListener('click', function() {
                    var button = this;
                    button.disabled = true;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traitement...';

                    fetch('{{ path('admin_message_mark_read', {id: message.id}) }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            _token: '{{ csrf_token('mark_read') }}'
                        })
                    })
                        .then(function(response) {
                            return response.json();
                        })
                        .then(function(result) {
                            if (result.success) {
                                showNotification('success', result.message);
                                button.remove();
                            } else {
                                button.disabled = false;
                                button.innerHTML = '<i class="fas fa-eye"></i> Marquer comme lu';
                                showNotification('error', result.error || 'Erreur lors du marquage');
                            }
                        })
                        .catch(function(error) {
                            button.disabled = false;
                            button.innerHTML = '<i class="fas fa-eye"></i> Marquer comme lu';
                            showNotification('error', 'Erreur de connexion');
                        });
                });
            }

            // Suppression du message
            var deleteBtn = document.getElementById('deleteMessage');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function() {
                    if (confirm('Êtes-vous sûr de vouloir supprimer ce message ?')) {
                        var form = document.createElement('form');
                        form.method = 'POST';
                        form.action = '{{ path('admin_message_delete', {id: message.id}) }}';

                        var tokenInput = document.createElement('input');
                        tokenInput.type = 'hidden';
                        tokenInput.name = '_token';
                        tokenInput.value = '{{ csrf_token('delete_message') }}';

                        form.appendChild(tokenInput);
                        document.body.appendChild(form);
                        form.submit();
                    }
                });
            }
        });
    </script>
{% endblock %}

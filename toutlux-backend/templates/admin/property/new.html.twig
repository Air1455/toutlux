{% extends 'base_admin.html.twig' %}

{% block title %}Nouvelle propriété - Admin TOUTLUX{% endblock %}

{% block page_title %}
    <i class="fas fa-home-plus"></i> Nouvelle propriété
{% endblock %}

{% block breadcrumb %}
    <ol class="breadcrumb float-sm-right">
        <li class="breadcrumb-item"><a href="{{ path('admin_dashboard') }}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{{ path('admin_property_index') }}">Propriétés</a></li>
        <li class="breadcrumb-item active">Nouvelle</li>
    </ol>
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-12">
            {% if form.vars.submitted and not form.vars.valid %}
                <div class="alert alert-danger alert-dismissible">
                    <button type="button" class="close" data-dismiss="alert">×</button>
                    <h5><i class="icon fas fa-ban"></i> Erreur!</h5>
                    Veuillez corriger les erreurs dans le formulaire.
                </div>
            {% endif %}

            <div class="card card-primary">
                <div class="card-header">
                    <h3 class="card-title">Créer une nouvelle propriété</h3>
                </div>

                {{ form_start(form, {'attr': {'enctype': 'multipart/form-data'}}) }}

                <div class="card-body">
                    {% include 'admin/property/_form.html.twig' %}
                </div>

                <div class="card-footer">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Créer la propriété
                    </button>
                    <a href="{{ path('admin_property_index') }}" class="btn btn-default">
                        <i class="fas fa-times"></i> Annuler
                    </a>
                </div>

                {{ form_end(form) }}
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_javascripts %}
    <script>
        $(document).ready(function() {
            // Validation spécifique pour la création
            $('form[name*="property"]').on('submit', function(e) {
                let isValid = true;

                // Vérification titre obligatoire
                const title = $('input[id$="_title"]').val();
                if (!title || title.trim().length < 5) {
                    showError('input[id$="_title"]', 'Le titre doit contenir au moins 5 caractères');
                    isValid = false;
                }

                // Vérification description obligatoire
                const description = $('textarea[id$="_description"]').val();
                if (!description || description.trim().length < 50) {
                    showError('textarea[id$="_description"]', 'La description doit contenir au moins 50 caractères');
                    isValid = false;
                }

                // Vérification prix obligatoire
                const price = $('input[id$="_price"]').val();
                if (!price || parseFloat(price) <= 0) {
                    showError('input[id$="_price"]', 'Le prix doit être supérieur à 0');
                    isValid = false;
                }

                // Vérification surface obligatoire
                const surface = $('input[id$="_surface"]').val();
                if (!surface || parseInt(surface) <= 0) {
                    showError('input[id$="_surface"]', 'La surface doit être supérieure à 0');
                    isValid = false;
                }

                // Vérification type obligatoire
                const type = $('select[id$="_type"]').val();
                if (!type) {
                    showError('select[id$="_type"]', 'Veuillez sélectionner un type');
                    isValid = false;
                }

                // Vérification adresse obligatoire
                const address = $('input[id$="_address"]').val();
                if (!address || address.trim().length < 5) {
                    showError('input[id$="_address"]', 'L\'adresse est obligatoire');
                    isValid = false;
                }

                // Vérification ville obligatoire
                const city = $('input[id$="_city"]').val();
                if (!city || city.trim().length < 2) {
                    showError('input[id$="_city"]', 'La ville est obligatoire');
                    isValid = false;
                }

                // Vérification code postal obligatoire
                const postalCode = $('input[id$="_postalCode"]').val();
                if (!postalCode || !/^[0-9]{5}$/.test(postalCode)) {
                    showError('input[id$="_postalCode"]', 'Le code postal doit contenir 5 chiffres');
                    isValid = false;
                }

                if (!isValid) {
                    e.preventDefault();
                    $('html, body').animate({
                        scrollTop: $('.is-invalid').first().offset().top - 100
                    }, 500);
                }
            });

            function showError(selector, message) {
                $(selector).addClass('is-invalid');
                if (!$(selector).next('.invalid-feedback').length) {
                    $(selector).after('<div class="invalid-feedback">' + message + '</div>');
                }
            }

            // Clear errors on input
            $('input, select, textarea').on('input change', function() {
                $(this).removeClass('is-invalid');
                $(this).next('.invalid-feedback').remove();
            });

            // Auto-complétion du meta titre à partir du titre
            $('input[id$="_title"]').on('input', function() {
                const title = $(this).val();
                const metaTitleField = $('input[id$="_metaTitle"]');
                if (!metaTitleField.val() && title) {
                    metaTitleField.val(title);
                }
            });

            // Auto-complétion de la meta description à partir de la description
            $('textarea[id$="_description"]').on('input', function() {
                const description = $(this).val();
                const metaDescField = $('textarea[id$="_metaDescription"]');
                if (!metaDescField.val() && description) {
                    const shortDesc = description.substring(0, 150) + (description.length > 150 ? '...' : '');
                    metaDescField.val(shortDesc);
                }
            });
        });
    </script>
{% endblock %}

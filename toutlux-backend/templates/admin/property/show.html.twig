{% extends 'base_admin.html.twig' %}

{% block title %}{{ property.title }} - Détails propriété{% endblock %}

{% block page_title %}
    <i class="fas fa-home"></i> {{ property.title }}
{% endblock %}

{% block breadcrumb %}
    <ol class="breadcrumb float-sm-right">
        <li class="breadcrumb-item"><a href="{{ path('admin_dashboard') }}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{{ path('admin_property_index') }}">Propriétés</a></li>
        <li class="breadcrumb-item active">{{ property.title|length > 30 ? property.title|slice(0, 30) ~ '...' : property.title }}</li>
    </ol>
{% endblock %}

{% block content %}
    <div class="row">
        <!-- Galerie et infos principales -->
        <div class="col-md-8">
            <!-- Galerie photos -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Photos ({{ property.images|length }})</h3>
                </div>
                <div class="card-body">
                    {% if property.images|length > 0 %}
                        <div id="propertyCarousel" class="carousel slide" data-ride="carousel">
                            <ol class="carousel-indicators">
                                {% for key, image in property.images %}
                                    <li data-target="#propertyCarousel" data-slide-to="{{ key }}"
                                        {% if key == 0 %}class="active"{% endif %}></li>
                                {% endfor %}
                            </ol>
                            <div class="carousel-inner">
                                {% for key, image in property.images %}
                                    <div class="carousel-item {% if key == 0 %}active{% endif %}">
                                        <img src="{{ asset('uploads/property_images/' ~ image.imageName) }}"
                                             class="d-block w-100"
                                             alt="{{ image.alt|default(property.title) }}"
                                             style="height: 400px; object-fit: cover;">
                                    </div>
                                {% endfor %}
                            </div>
                            <a class="carousel-control-prev" href="#propertyCarousel" role="button" data-slide="prev">
                                <span class="carousel-control-prev-icon"></span>
                            </a>
                            <a class="carousel-control-next" href="#propertyCarousel" role="button" data-slide="next">
                                <span class="carousel-control-next-icon"></span>
                            </a>
                        </div>

                        <!-- Miniatures -->
                        <div class="row mt-3">
                            {% for image in property.images %}
                                <div class="col-md-2 col-sm-3 col-4">
                                    <img src="{{ asset('uploads/property_images/' ~ image.imageName) }}"
                                         class="img-thumbnail mb-2"
                                         style="cursor: pointer; height: 80px; object-fit: cover;"
                                         onclick="$('#propertyCarousel').carousel({{ loop.index0 }})">
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-image fa-3x text-muted"></i>
                            <p class="text-muted mt-2">Aucune photo disponible</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Description -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Description</h3>
                </div>
                <div class="card-body">
                    <p style="white-space: pre-wrap;">{{ property.description }}</p>
                </div>
            </div>

            <!-- Caractéristiques -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Caractéristiques</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <th style="width: 40%">Surface :</th>
                                    <td>{{ property.surface }} m²</td>
                                </tr>
                                <tr>
                                    <th>Nombre de pièces :</th>
                                    <td>{{ property.rooms }}</td>
                                </tr>
                                <tr>
                                    <th>Chambres :</th>
                                    <td>{{ property.bedrooms }}</td>
                                </tr>
                                <tr>
                                    <th>Salles de bain :</th>
                                    <td>{{ property.bathrooms }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <th style="width: 40%">Type :</th>
                                    <td>
                                        {% if property.type == 'sale' %}
                                            <span class="badge badge-success">Vente</span>
                                        {% else %}
                                            <span class="badge badge-info">Location</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Prix au m² :</th>
                                    <td>
                                        {% if property.pricePerSquareMeter %}
                                            {{ property.pricePerSquareMeter|number_format(0, ',', ' ') }} €/m²
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Vues :</th>
                                    <td>{{ property.viewCount|number_format }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Features -->
                    {% if property.features and property.features|length > 0 %}
                        <h5 class="mt-3">Équipements et prestations</h5>
                        <div class="row">
                            {% for feature in property.features %}
                                <div class="col-md-4 col-sm-6">
                                    <i class="fas fa-check text-success"></i> {{ feature }}
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Messages liés -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Messages ({{ property.messages|length }})</h3>
                </div>
                <div class="card-body">
                    {% if property.messages|length > 0 %}
                        <div class="direct-chat-messages" style="height: 300px;">
                            {% for message in property.messages|slice(0, 20) %}
                                <div class="direct-chat-msg">
                                    <div class="direct-chat-infos clearfix">
                                        <span class="direct-chat-name float-left">
                                            {{ message.sender.fullName }}
                                        </span>
                                        <span class="direct-chat-timestamp float-right">
                                            {{ message.createdAt|date('d/m/Y H:i') }}
                                        </span>
                                    </div>
                                    <div class="direct-chat-text">
                                        {{ message.content }}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted text-center">Aucun message pour cette propriété</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar infos -->
        <div class="col-md-4">
            <!-- Prix et statut -->
            <div class="card card-primary">
                <div class="card-header">
                    <h3 class="card-title">Informations principales</h3>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <h2 class="text-primary">
                            {{ property.price|number_format(0, ',', ' ') }} €
                            {% if property.type == 'rent' %}
                                <small>/mois</small>
                            {% endif %}
                        </h2>
                        {% if property.type == 'sale' %}
                            <span class="badge badge-success">Vente</span>
                        {% else %}
                            <span class="badge badge-info">Location</span>
                        {% endif %}
                    </div>

                    <hr>

                    <p><strong>ID :</strong> #{{ property.id }}</p>
                    <p><strong>Statut :</strong>
                        {% if property.featured %}
                            <span class="badge badge-warning">En vedette</span>
                        {% elseif property.verified %}
                            <span class="badge badge-primary">Vérifié</span>
                        {% elseif property.available %}
                            <span class="badge badge-success">Disponible</span>
                        {% else %}
                            <span class="badge badge-danger">Non disponible</span>
                        {% endif %}
                    </p>
                    <p><strong>Vues :</strong> {{ property.viewCount|number_format }}</p>

                    <hr>

                    <div class="btn-group btn-block">
                        <a href="{{ path('admin_property_edit', {'id': property.id}) }}"
                           class="btn btn-warning">
                            <i class="fas fa-edit"></i> Modifier
                        </a>
                        {% if not property.featured %}
                            <button class="btn btn-info" id="toggleFeatured">
                                <i class="fas fa-star"></i> Vedette
                            </button>
                        {% else %}
                            <button class="btn btn-outline-info" id="toggleFeatured">
                                <i class="fas fa-star"></i> Retirer vedette
                            </button>
                        {% endif %}
                    </div>

                    {% if not property.verified %}
                        <button class="btn btn-success btn-block mt-2" id="toggleVerified">
                            <i class="fas fa-check"></i> Marquer comme vérifié
                        </button>
                    {% else %}
                        <button class="btn btn-outline-success btn-block mt-2" id="toggleVerified">
                            <i class="fas fa-times"></i> Retirer la vérification
                        </button>
                    {% endif %}

                    <button class="btn btn-{{ property.available ? 'danger' : 'success' }} btn-block mt-2" id="toggleAvailable">
                        <i class="fas fa-{{ property.available ? 'ban' : 'check' }}"></i>
                        {{ property.available ? 'Marquer indisponible' : 'Marquer disponible' }}
                    </button>

                    <button class="btn btn-danger btn-block mt-2" id="deleteProperty">
                        <i class="fas fa-trash"></i> Supprimer
                    </button>
                </div>
            </div>

            <!-- Localisation -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Localisation</h3>
                </div>
                <div class="card-body">
                    <p><strong>Adresse :</strong><br>{{ property.address }}</p>
                    <p><strong>Ville :</strong> {{ property.city }}</p>
                    <p><strong>Code postal :</strong> {{ property.postalCode }}</p>

                    {% if property.latitude and property.longitude %}
                        <hr>
                        <p><strong>Coordonnées :</strong></p>
                        <small class="text-muted">
                            Lat: {{ property.latitude }}, Lng: {{ property.longitude }}
                        </small>
                    {% endif %}
                </div>
            </div>

            <!-- Propriétaire -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Propriétaire</h3>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        {% if property.owner.avatarUrl %}
                            <img src="{{ property.owner.avatarUrl }}"
                                 alt="{{ property.owner.fullName }}"
                                 class="img-circle img-size-64">
                        {% else %}
                            <div class="img-circle img-size-64 bg-secondary d-flex align-items-center justify-content-center mx-auto">
                                <i class="fas fa-user fa-2x"></i>
                            </div>
                        {% endif %}
                    </div>

                    <p class="text-center">
                        <strong>{{ property.owner.fullName }}</strong><br>
                        <span class="text-warning">
                            {% for i in 1..5 %}
                                {% if i <= property.owner.trustScore %}
                                    <i class="fas fa-star"></i>
                                {% else %}
                                    <i class="far fa-star"></i>
                                {% endif %}
                            {% endfor %}
                        </span>
                    </p>

                    <table class="table table-sm">
                        <tr>
                            <td>Email :</td>
                            <td>{{ property.owner.email }}</td>
                        </tr>
                        <tr>
                            <td>Tél :</td>
                            <td>{{ property.owner.phone|default('N/A') }}</td>
                        </tr>
                        <tr>
                            <td>Propriétés :</td>
                            <td>{{ property.owner.properties|length }}</td>
                        </tr>
                    </table>

                    <a href="{{ path('admin_user_show', {'id': property.owner.id}) }}"
                       class="btn btn-sm btn-default btn-block">
                        <i class="fas fa-user"></i> Voir le profil
                    </a>
                </div>
            </div>

            <!-- Historique -->
            <div class="card collapsed-card">
                <div class="card-header">
                    <h3 class="card-title">Historique</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <p><strong>Créé le :</strong><br>{{ property.createdAt|date('d/m/Y à H:i') }}</p>
                    <p><strong>Dernière modification :</strong><br>{{ property.updatedAt|date('d/m/Y à H:i') }}</p>

                    <h6 class="mt-3">Statuts :</h6>
                    <ul class="list-unstyled">
                        <li>
                            <i class="fas fa-{{ property.available ? 'check text-success' : 'times text-danger' }}"></i>
                            {{ property.available ? 'Disponible' : 'Non disponible' }}
                        </li>
                        <li>
                            <i class="fas fa-{{ property.verified ? 'check text-success' : 'times text-danger' }}"></i>
                            {{ property.verified ? 'Vérifié' : 'Non vérifié' }}
                        </li>
                        <li>
                            <i class="fas fa-{{ property.featured ? 'star text-warning' : 'times text-muted' }}"></i>
                            {{ property.featured ? 'En vedette' : 'Non en vedette' }}
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_javascripts %}
    <script>
        $(document).ready(function() {
            // Toggle Featured
            $('#toggleFeatured').click(function() {
                const btn = $(this);
                btn.prop('disabled', true);

                $.post('{{ path('admin_property_toggle_featured', {'id': property.id}) }}', {
                    _token: '{{ csrf_token('toggle_featured') }}'
                })
                    .done(function(response) {
                        if (response.success) {
                            location.reload();
                        }
                    })
                    .fail(function() {
                        alert('Une erreur est survenue');
                    })
                    .always(function() {
                        btn.prop('disabled', false);
                    });
            });

            // Toggle Verified
            $('#toggleVerified').click(function() {
                const btn = $(this);
                btn.prop('disabled', true);

                $.post('{{ path('admin_property_toggle_verified', {'id': property.id}) }}', {
                    _token: '{{ csrf_token('toggle_verified') }}'
                })
                    .done(function(response) {
                        if (response.success) {
                            location.reload();
                        }
                    })
                    .fail(function() {
                        alert('Une erreur est survenue');
                    })
                    .always(function() {
                        btn.prop('disabled', false);
                    });
            });

            // Toggle Available
            $('#toggleAvailable').click(function() {
                const btn = $(this);
                btn.prop('disabled', true);

                $.post('{{ path('admin_property_toggle_available', {'id': property.id}) }}', {
                    _token: '{{ csrf_token('toggle_available') }}'
                })
                    .done(function(response) {
                        if (response.success) {
                            location.reload();
                        }
                    })
                    .fail(function() {
                        alert('Une erreur est survenue');
                    })
                    .always(function() {
                        btn.prop('disabled', false);
                    });
            });

            // Delete Property
            $('#deleteProperty').click(function() {
                if (confirm('Êtes-vous sûr de vouloir supprimer cette propriété ? Cette action est irréversible.')) {
                    const form = $('<form method="post" action="{{ path('admin_property_delete', {'id': property.id}) }}"></form>');
                    form.append('<input type="hidden" name="_token" value="{{ csrf_token('delete' ~ property.id) }}">');
                    $('body').append(form);
                    form.submit();
                }
            });
        });
    </script>
{% endblock %}

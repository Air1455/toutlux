{% extends 'base_admin.html.twig' %}

{% block title %}Nouvel utilisateur - Admin TOUTLUX{% endblock %}

{% block page_title %}
    <i class="fas fa-user-plus"></i> Nouvel utilisateur
{% endblock %}

{% block breadcrumb %}
    <ol class="breadcrumb float-sm-right">
        <li class="breadcrumb-item"><a href="{{ path('admin_dashboard') }}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{{ path('admin_user_index') }}">Utilisateurs</a></li>
        <li class="breadcrumb-item active">Nouveau</li>
    </ol>
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-12">
            {% if form.vars.submitted and not form.vars.valid %}
                <div class="alert alert-danger alert-dismissible">
                    <button type="button" class="close" data-dismiss="alert">×</button>
                    <h5><i class="icon fas fa-ban"></i> Erreur!</h5>
                    Veuillez corriger les erreurs dans le formulaire.
                </div>
            {% endif %}

            <div class="card card-primary">
                <div class="card-header">
                    <h3 class="card-title">Créer un nouvel utilisateur</h3>
                </div>

                {{ form_start(form, {'attr': {'enctype': 'multipart/form-data'}}) }}

                <div class="card-body">
                    {% include 'admin/user/_form.html.twig' %}
                </div>

                <div class="card-footer">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Créer l'utilisateur
                    </button>
                    <a href="{{ path('admin_user_index') }}" class="btn btn-default">
                        <i class="fas fa-times"></i> Annuler
                    </a>
                </div>

                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_javascripts %}
    <script>
        $(document).ready(function() {
            // Le JavaScript est maintenant dans _form.html.twig

            // Validation spécifique pour la création
            $('form').on('submit', function(e) {
                let isValid = true;

                // Vérification email obligatoire
                {% if form.email is defined %}
                const email = $('input[name="{{ form.email.vars.full_name }}"]').val();
                if (!email || !isValidEmail(email)) {
                    showError('input[name="{{ form.email.vars.full_name }}"]', 'Email invalide ou manquant');
                    isValid = false;
                }
                {% endif %}

                if (!isValid) {
                    e.preventDefault();
                }
            });

            function isValidEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            }

            function showError(selector, message) {
                $(selector).addClass('is-invalid');
                $(selector).parent().append('<div class="invalid-feedback">' + message + '</div>');
            }

            // Clear errors on input
            $('input').on('input', function() {
                $(this).removeClass('is-invalid');
                $(this).parent().find('.invalid-feedback').remove();
            });
        });
    </script>
{% endblock %}

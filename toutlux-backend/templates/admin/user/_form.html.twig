{# Partial form pour création/édition utilisateur #}

<div class="row">
    <!-- Informations de connexion -->
    <div class="col-md-6">
        <div class="card card-outline card-primary">
            <div class="card-header">
                <h4 class="card-title">Informations de connexion</h4>
            </div>
            <div class="card-body">
                {% if form.email is defined %}
                    <div class="form-group">
                        {{ form_label(form.email) }}
                        {{ form_widget(form.email, {'attr': {'class': 'form-control', 'placeholder': 'email@exemple.com'}}) }}
                        {{ form_errors(form.email) }}
                    </div>
                {% endif %}

                {% if form.plainPassword is defined %}
                    <div class="form-group">
                        {{ form_label(form.plainPassword, 'Mot de passe') }}
                        <div class="input-group">
                            {{ form_widget(form.plainPassword, {'attr': {'class': 'form-control', 'placeholder': 'Minimum 8 caractères'}}) }}
                            <div class="input-group-append">
                                <button type="button" class="btn btn-outline-secondary" id="generatePassword">
                                    <i class="fas fa-key"></i> Générer
                                </button>
                            </div>
                        </div>
                        {{ form_errors(form.plainPassword) }}
                        <small class="form-text text-muted">Laissez vide pour conserver le mot de passe actuel</small>
                    </div>
                {% endif %}

                {% if form.roles is defined %}
                    <div class="form-group">
                        {{ form_label(form.roles) }}
                        {{ form_widget(form.roles, {'attr': {'class': 'form-control'}}) }}
                        {{ form_errors(form.roles) }}
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> Les super admins ont accès à toutes les fonctionnalités
                        </small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Informations personnelles -->
    <div class="col-md-6">
        <div class="card card-outline card-info">
            <div class="card-header">
                <h4 class="card-title">Informations personnelles</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        {% if form.firstName is defined %}
                            <div class="form-group">
                                {{ form_label(form.firstName) }}
                                {{ form_widget(form.firstName, {'attr': {'class': 'form-control'}}) }}
                                {{ form_errors(form.firstName) }}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {% if form.lastName is defined %}
                            <div class="form-group">
                                {{ form_label(form.lastName) }}
                                {{ form_widget(form.lastName, {'attr': {'class': 'form-control'}}) }}
                                {{ form_errors(form.lastName) }}
                            </div>
                        {% endif %}
                    </div>
                </div>

                {% if form.phone is defined %}
                    <div class="form-group">
                        {{ form_label(form.phone) }}
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-phone"></i></span>
                            </div>
                            {{ form_widget(form.phone, {'attr': {'class': 'form-control', 'placeholder': '+228 90 00 00 00'}}) }}
                        </div>
                        {{ form_errors(form.phone) }}
                    </div>
                {% endif %}

                <div class="row">
                    <div class="col-md-6">
                        {% if form.birthDate is defined %}
                            <div class="form-group">
                                {{ form_label(form.birthDate) }}
                                {{ form_widget(form.birthDate, {'attr': {'class': 'form-control'}}) }}
                                {{ form_errors(form.birthDate) }}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {% if form.country is defined %}
                            <div class="form-group">
                                {{ form_label(form.country) }}
                                {{ form_widget(form.country, {'attr': {'class': 'form-control', 'placeholder': 'TG'}}) }}
                                {{ form_errors(form.country) }}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <!-- Localisation -->
    <div class="col-md-6">
        <div class="card card-outline card-success">
            <div class="card-header">
                <h4 class="card-title">Localisation</h4>
            </div>
            <div class="card-body">
                {% if form.address is defined %}
                    <div class="form-group">
                        {{ form_label(form.address) }}
                        {{ form_widget(form.address, {'attr': {'class': 'form-control', 'rows': 2}}) }}
                        {{ form_errors(form.address) }}
                    </div>
                {% endif %}

                <div class="row">
                    <div class="col-md-6">
                        {% if form.city is defined %}
                            <div class="form-group">
                                {{ form_label(form.city) }}
                                {{ form_widget(form.city, {'attr': {'class': 'form-control'}}) }}
                                {{ form_errors(form.city) }}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {% if form.postalCode is defined %}
                            <div class="form-group">
                                {{ form_label(form.postalCode) }}
                                {{ form_widget(form.postalCode, {'attr': {'class': 'form-control'}}) }}
                                {{ form_errors(form.postalCode) }}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statut et options -->
    <div class="col-md-6">
        <div class="card card-outline card-warning">
            <div class="card-header">
                <h4 class="card-title">Statut et options</h4>
            </div>
            <div class="card-body">
                <!-- Statut du compte -->
                {% if form.active is defined %}
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            {{ form_widget(form.active, {'attr': {'class': 'custom-control-input'}}) }}
                            {{ form_label(form.active, 'Compte actif', {'label_attr': {'class': 'custom-control-label'}}) }}
                        </div>
                        {{ form_errors(form.active) }}
                    </div>
                {% endif %}

                {% if form.isEmailVerified is defined %}
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            {{ form_widget(form.isEmailVerified, {'attr': {'class': 'custom-control-input'}}) }}
                            {{ form_label(form.isEmailVerified, 'Email vérifié', {'label_attr': {'class': 'custom-control-label'}}) }}
                        </div>
                        {{ form_errors(form.isEmailVerified) }}
                    </div>
                {% endif %}

                {% if form.phoneVerified is defined %}
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            {{ form_widget(form.phoneVerified, {'attr': {'class': 'custom-control-input'}}) }}
                            {{ form_label(form.phoneVerified, 'Téléphone vérifié', {'label_attr': {'class': 'custom-control-label'}}) }}
                        </div>
                        {{ form_errors(form.phoneVerified) }}
                    </div>
                {% endif %}

                {% if form.identityVerified is defined %}
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            {{ form_widget(form.identityVerified, {'attr': {'class': 'custom-control-input'}}) }}
                            {{ form_label(form.identityVerified, 'Identité vérifiée', {'label_attr': {'class': 'custom-control-label'}}) }}
                        </div>
                        {{ form_errors(form.identityVerified) }}
                    </div>
                {% endif %}

                {% if form.financialVerified is defined %}
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            {{ form_widget(form.financialVerified, {'attr': {'class': 'custom-control-input'}}) }}
                            {{ form_label(form.financialVerified, 'Documents financiers vérifiés', {'label_attr': {'class': 'custom-control-label'}}) }}
                        </div>
                        {{ form_errors(form.financialVerified) }}
                    </div>
                {% endif %}

                {% if form.termsAccepted is defined %}
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            {{ form_widget(form.termsAccepted, {'attr': {'class': 'custom-control-input'}}) }}
                            {{ form_label(form.termsAccepted, 'Conditions acceptées', {'label_attr': {'class': 'custom-control-label'}}) }}
                        </div>
                        {{ form_errors(form.termsAccepted) }}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Photo de profil et notifications -->
<div class="row mt-3">
    <div class="col-md-6">
        <div class="card card-outline card-secondary">
            <div class="card-header">
                <h4 class="card-title">Photo de profil</h4>
            </div>
            <div class="card-body">
                {% if form.avatarFile is defined %}
                    <div class="form-group">
                        {{ form_label(form.avatarFile, 'Photo de profil') }}
                        {% if user is defined and user.avatarUrl %}
                            <div class="mb-2">
                                <img src="{{ user.avatarUrl }}"
                                     alt="Photo actuelle"
                                     class="img-thumbnail"
                                     style="max-width: 150px;">
                                <small class="d-block text-muted">Photo actuelle</small>
                            </div>
                        {% endif %}
                        {{ form_widget(form.avatarFile, {'attr': {'class': 'form-control-file', 'accept': 'image/*'}}) }}
                        {{ form_errors(form.avatarFile) }}
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> Formats acceptés : JPG, PNG, WebP. Taille max : 5MB
                        </small>
                    </div>
                {% endif %}

                {% if form.bio is defined %}
                    <div class="form-group">
                        {{ form_label(form.bio, 'Biographie') }}
                        {{ form_widget(form.bio, {'attr': {'class': 'form-control', 'rows': 3, 'placeholder': 'Quelques mots sur l\'utilisateur...'}}) }}
                        {{ form_errors(form.bio) }}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card card-outline card-info">
            <div class="card-header">
                <h4 class="card-title">Notifications</h4>
            </div>
            <div class="card-body">
                {% if form.emailNotificationsEnabled is defined %}
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            {{ form_widget(form.emailNotificationsEnabled, {'attr': {'class': 'custom-control-input'}}) }}
                            {{ form_label(form.emailNotificationsEnabled, 'Notifications email activées', {'label_attr': {'class': 'custom-control-label'}}) }}
                        </div>
                        {{ form_errors(form.emailNotificationsEnabled) }}
                    </div>
                {% endif %}

                {% if form.smsNotificationsEnabled is defined %}
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            {{ form_widget(form.smsNotificationsEnabled, {'attr': {'class': 'custom-control-input'}}) }}
                            {{ form_label(form.smsNotificationsEnabled, 'Notifications SMS activées', {'label_attr': {'class': 'custom-control-label'}}) }}
                        </div>
                        {{ form_errors(form.smsNotificationsEnabled) }}
                    </div>
                {% endif %}

                {% if form.profileCompleted is defined %}
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            {{ form_widget(form.profileCompleted, {'attr': {'class': 'custom-control-input', 'disabled': 'disabled'}}) }}
                            {{ form_label(form.profileCompleted, 'Profil complété', {'label_attr': {'class': 'custom-control-label'}}) }}
                        </div>
                        <small class="form-text text-muted">Calculé automatiquement</small>
                        {{ form_errors(form.profileCompleted) }}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div id="generatedPasswordAlert" class="alert alert-info mt-3" style="display: none;">
    <i class="fas fa-info-circle"></i> Mot de passe généré : <strong id="generatedPassword"></strong>
    <small class="d-block">Assurez-vous de le communiquer à l'utilisateur de manière sécurisée.</small>
</div>

<script>
    $(document).ready(function() {
        // Génération du mot de passe
        $('#generatePassword').click(function() {
            const password = generateSecurePassword();
            {% if form.plainPassword is defined %}
            $('input[name="{{ form.plainPassword.vars.full_name }}"]').val(password);
            {% endif %}
            $('#generatedPassword').text(password);
            $('#generatedPasswordAlert').show();
        });

        function generateSecurePassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < 12; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        // Auto-format phone number
        {% if form.phone is defined %}
        $('input[name="{{ form.phone.vars.full_name }}"]').on('input', function() {
            let value = $(this).val().replace(/\s/g, '');
            if (value.length > 3 && !value.startsWith('+')) {
                value = value.match(/.{1,2}/g)?.join(' ') || value;
            }
            $(this).val(value);
        });
        {% endif %}

        // Preview image before upload
        {% if form.avatarFile is defined %}
        $('input[name="{{ form.avatarFile.vars.full_name }}"]').change(function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Remove previous preview
                    $(this).siblings('.avatar-preview').remove();
                    // Add new preview
                    const preview = $('<img>').attr('src', e.target.result)
                        .addClass('img-thumbnail mt-2 avatar-preview')
                        .css('max-width', '150px');
                    $('input[name="{{ form.avatarFile.vars.full_name }}"]').after(preview);
                }.bind(this);
                reader.readAsDataURL(file);
            }
        });
        {% endif %}
    });
</script>

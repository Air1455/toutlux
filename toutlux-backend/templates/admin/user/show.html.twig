{% extends 'base_admin.html.twig' %}

{% block title %}{{ user.fullName }} - Détails utilisateur{% endblock %}

{% block page_title %}
    <i class="fas fa-user"></i> {{ user.fullName }}
{% endblock %}

{% block breadcrumb %}
    <ol class="breadcrumb float-sm-right">
        <li class="breadcrumb-item"><a href="{{ path('admin_dashboard') }}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{{ path('admin_user_index') }}">Utilisateurs</a></li>
        <li class="breadcrumb-item active">{{ user.fullName }}</li>
    </ol>
{% endblock %}

{% block content %}
    <div class="row">
        <!-- Informations principales -->
        <div class="col-md-3">
            <div class="card card-primary card-outline">
                <div class="card-body box-profile">
                    <div class="text-center">
                        {% if user.profilePicture %}
                            <img class="profile-user-img img-fluid img-circle"
                                 src="{{ asset('uploads/users/' ~ user.profilePicture) }}"
                                 alt="{{ user.fullName }}">
                        {% else %}
                            <div class="profile-user-img img-fluid img-circle bg-secondary d-flex align-items-center justify-content-center"
                                 style="width: 100px; height: 100px; margin: 0 auto;">
                                <i class="fas fa-user fa-3x"></i>
                            </div>
                        {% endif %}
                    </div>

                    <h3 class="profile-username text-center">{{ user.fullName }}</h3>

                    <p class="text-muted text-center">
                        {% if 'ROLE_SUPER_ADMIN' in user.roles %}
                            <span class="badge badge-danger">Super Admin</span>
                        {% elseif 'ROLE_ADMIN' in user.roles %}
                            <span class="badge badge-warning">Admin</span>
                        {% else %}
                            <span class="badge badge-info">Utilisateur</span>
                        {% endif %}
                    </p>

                    <ul class="list-group list-group-unbordered mb-3">
                        <li class="list-group-item">
                            <b>Score de confiance</b>
                            <a class="float-right">
                                <div class="text-warning">
                                    {% for i in 1..5 %}
                                        {% if i <= user.trustScore %}
                                            <i class="fas fa-star"></i>
                                        {% else %}
                                            <i class="far fa-star"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </a>
                        </li>
                        <li class="list-group-item">
                            <b>Propriétés</b> <a class="float-right">{{ user.properties|length }}</a>
                        </li>
                        <li class="list-group-item">
                            <b>Documents</b> <a class="float-right">{{ user.documents|length }}</a>
                        </li>
                        <li class="list-group-item">
                            <b>Messages</b> <a class="float-right">{{ user.sentMessages|length + user.receivedMessages|length }}</a>
                        </li>
                    </ul>

                    <div class="btn-group btn-block">
                        <a href="{{ path('admin_user_edit', {'id': user.id}) }}" class="btn btn-primary">
                            <i class="fas fa-edit"></i> Modifier
                        </a>
                        {% if user.isActive %}
                            <button class="btn btn-danger" id="deactivateUser">
                                <i class="fas fa-ban"></i> Désactiver
                            </button>
                        {% else %}
                            <button class="btn btn-success" id="activateUser">
                                <i class="fas fa-check"></i> Activer
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Statut du profil -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Complétude du profil</h3>
                </div>
                <div class="card-body">
                    <div class="progress mb-3">
                        <div class="progress-bar bg-success" style="width: {{ user.profileCompletionPercentage }}%">
                            {{ user.profileCompletionPercentage }}%
                        </div>
                    </div>

                    <ul class="list-unstyled">
                        <li>
                            {% if user.isGeneralInfoComplete %}
                                <i class="fas fa-check text-success"></i>
                            {% else %}
                                <i class="fas fa-times text-danger"></i>
                            {% endif %}
                            Informations générales
                        </li>
                        <li>
                            {% if user.isLocationComplete %}
                                <i class="fas fa-check text-success"></i>
                            {% else %}
                                <i class="fas fa-times text-danger"></i>
                            {% endif %}
                            Localisation
                        </li>
                        <li>
                            {% if user.isProfessionalInfoComplete %}
                                <i class="fas fa-check text-success"></i>
                            {% else %}
                                <i class="fas fa-times text-danger"></i>
                            {% endif %}
                            Informations professionnelles
                        </li>
                        <li>
                            {% if user.isFinancialInfoComplete %}
                                <i class="fas fa-check text-success"></i>
                            {% else %}
                                <i class="fas fa-times text-danger"></i>
                            {% endif %}
                            Informations financières
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Détails et activités -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header p-2">
                    <ul class="nav nav-pills">
                        <li class="nav-item"><a class="nav-link active" href="#details" data-toggle="tab">Détails</a></li>
                        <li class="nav-item"><a class="nav-link" href="#properties" data-toggle="tab">Propriétés</a></li>
                        <li class="nav-item"><a class="nav-link" href="#documents" data-toggle="tab">Documents</a></li>
                        <li class="nav-item"><a class="nav-link" href="#messages" data-toggle="tab">Messages</a></li>
                        <li class="nav-item"><a class="nav-link" href="#activity" data-toggle="tab">Activité</a></li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <!-- Tab Détails -->
                        <div class="active tab-pane" id="details">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>Informations personnelles</h5>
                                    <table class="table table-sm">
                                        <tr>
                                            <th style="width: 40%">Email :</th>
                                            <td>
                                                {{ user.email }}
                                                {% if user.isVerified %}
                                                    <i class="fas fa-check-circle text-success"></i>
                                                {% else %}
                                                    <i class="fas fa-exclamation-circle text-warning"></i>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Téléphone :</th>
                                            <td>{{ user.phoneNumber|default('-') }}</td>
                                        </tr>
                                        <tr>
                                            <th>Date de naissance :</th>
                                            <td>{{ user.birthDate ? user.birthDate|date('d/m/Y') : '-' }}</td>
                                        </tr>
                                        <tr>
                                            <th>Genre :</th>
                                            <td>{{ user.gender|default('-') }}</td>
                                        </tr>
                                        <tr>
                                            <th>Nationalité :</th>
                                            <td>{{ user.nationality|default('-') }}</td>
                                        </tr>
                                        <tr>
                                            <th>Langue préférée :</th>
                                            <td>{{ user.preferredLanguage|default('fr') }}</td>
                                        </tr>
                                    </table>
                                </div>

                                <div class="col-md-6">
                                    <h5>Localisation</h5>
                                    <table class="table table-sm">
                                        <tr>
                                            <th style="width: 40%">Adresse :</th>
                                            <td>{{ user.address|default('-') }}</td>
                                        </tr>
                                        <tr>
                                            <th>Ville :</th>
                                            <td>{{ user.city|default('-') }}</td>
                                        </tr>
                                        <tr>
                                            <th>Code postal :</th>
                                            <td>{{ user.postalCode|default('-') }}</td>
                                        </tr>
                                        <tr>
                                            <th>Pays :</th>
                                            <td>{{ user.country|default('-') }}</td>
                                        </tr>
                                    </table>

                                    <h5 class="mt-4">Informations professionnelles</h5>
                                    <table class="table table-sm">
                                        <tr>
                                            <th style="width: 40%">Profession :</th>
                                            <td>{{ user.occupation|default('-') }}</td>
                                        </tr>
                                        <tr>
                                            <th>Employeur :</th>
                                            <td>{{ user.employer|default('-') }}</td>
                                        </tr>
                                        <tr>
                                            <th>Revenus mensuels :</th>
                                            <td>{{ user.monthlyIncome ? user.monthlyIncome|number_format(0, ',', ' ') ~ ' €' : '-' }}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            <div class="row mt-4">
                                <div class="col-md-12">
                                    <h5>Informations système</h5>
                                    <table class="table table-sm">
                                        <tr>
                                            <th style="width: 20%">ID :</th>
                                            <td>{{ user.id }}</td>
                                        </tr>
                                        <tr>
                                            <th>Inscrit le :</th>
                                            <td>{{ user.createdAt|date('d/m/Y à H:i') }}</td>
                                        </tr>
                                        <tr>
                                            <th>Dernière mise à jour :</th>
                                            <td>{{ user.updatedAt|date('d/m/Y à H:i') }}</td>
                                        </tr>
                                        <tr>
                                            <th>Dernière connexion :</th>
                                            <td>{{ user.lastLoginAt ? user.lastLoginAt|date('d/m/Y à H:i') : 'Jamais' }}</td>
                                        </tr>
                                        <tr>
                                            <th>Connexion Google :</th>
                                            <td>
                                                {% if user.googleId %}
                                                    <i class="fab fa-google text-danger"></i> Oui (ID: {{ user.googleId }})
                                                {% else %}
                                                    Non
                                                {% endif %}
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Tab Propriétés -->
                        <div class="tab-pane" id="properties">
                            {% if user.properties|length > 0 %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                        <tr>
                                            <th>Photo</th>
                                            <th>Titre</th>
                                            <th>Type</th>
                                            <th>Prix</th>
                                            <th>Ville</th>
                                            <th>Statut</th>
                                            <th>Actions</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% for property in user.properties %}
                                            <tr>
                                                <td>
                                                    {% if property.images|length > 0 %}
                                                        <img src="{{ asset('uploads/properties/' ~ property.images[0].filename) }}"
                                                             alt="{{ property.title }}"
                                                             style="width: 50px; height: 50px; object-fit: cover;">
                                                    {% else %}
                                                        <div class="bg-secondary d-flex align-items-center justify-content-center"
                                                             style="width: 50px; height: 50px;">
                                                            <i class="fas fa-home"></i>
                                                        </div>
                                                    {% endif %}
                                                </td>
                                                <td>{{ property.title }}</td>
                                                <td>
                                                    {% if property.type == 'sale' %}
                                                        <span class="badge badge-success">Vente</span>
                                                    {% else %}
                                                        <span class="badge badge-info">Location</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ property.price|number_format(0, ',', ' ') }} €</td>
                                                <td>{{ property.city }}</td>
                                                <td>
                                                    {% if property.status == 'available' %}
                                                        <span class="badge badge-success">Disponible</span>
                                                    {% elseif property.status == 'verified' %}
                                                        <span class="badge badge-primary">Vérifié</span>
                                                    {% else %}
                                                        <span class="badge badge-warning">En vedette</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <a href="{{ path('admin_property_show', {'id': property.id}) }}"
                                                       class="btn btn-sm btn-info">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <p class="text-muted">Aucune propriété publiée</p>
                            {% endif %}
                        </div>

                        <!-- Tab Documents -->
                        <div class="tab-pane" id="documents">
                            {% if user.documents|length > 0 %}
                                <div class="row">
                                    {% for document in user.documents %}
                                        <div class="col-md-6 mb-3">
                                            <div class="card {% if document.status == 'APPROVED' %}card-success{% elseif document.status == 'REJECTED' %}card-danger{% else %}card-warning{% endif %}">
                                                <div class="card-header">
                                                    <h5 class="card-title">{{ document.type }}</h5>
                                                    <div class="card-tools">
                                                        {% if document.status == 'APPROVED' %}
                                                            <span class="badge badge-success">Approuvé</span>
                                                        {% elseif document.status == 'REJECTED' %}
                                                            <span class="badge badge-danger">Rejeté</span>
                                                        {% elseif document.status == 'EXPIRED' %}
                                                            <span class="badge badge-secondary">Expiré</span>
                                                        {% else %}
                                                            <span class="badge badge-warning">En attente</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <p>
                                                        <strong>Uploadé le :</strong> {{ document.uploadedAt|date('d/m/Y H:i') }}<br>
                                                        {% if document.validatedAt %}
                                                            <strong>Validé le :</strong> {{ document.validatedAt|date('d/m/Y H:i') }}<br>
                                                        {% endif %}
                                                        {% if document.expiresAt %}
                                                            <strong>Expire le :</strong> {{ document.expiresAt|date('d/m/Y') }}<br>
                                                        {% endif %}
                                                    </p>
                                                    <a href="{{ path('admin_document_validate', {'id': document.id}) }}"
                                                       class="btn btn-sm btn-primary">
                                                        <i class="fas fa-file"></i> Voir le document
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted">Aucun document uploadé</p>
                            {% endif %}
                        </div>

                        <!-- Tab Messages -->
                        <div class="tab-pane" id="messages">
                            <div class="direct-chat-messages" style="height: 400px;">
                                {% set allMessages = user.sentMessages|merge(user.receivedMessages)|sort((a, b) => b.createdAt <=> a.createdAt) %}
                                {% for message in allMessages|slice(0, 20) %}
                                    <div class="direct-chat-msg {% if message.sender.id == user.id %}right{% endif %}">
                                        <div class="direct-chat-infos clearfix">
                                            <span class="direct-chat-name {% if message.sender.id == user.id %}float-right{% else %}float-left{% endif %}">
                                                {{ message.sender.fullName }}
                                            </span>
                                            <span class="direct-chat-timestamp {% if message.sender.id == user.id %}float-left{% else %}float-right{% endif %}">
                                                {{ message.createdAt|date('d/m H:i') }}
                                            </span>
                                        </div>
                                        <img class="direct-chat-img"
                                             src="{{ asset('dist/img/user1-128x128.jpg') }}"
                                             alt="Message User Image">
                                        <div class="direct-chat-text">
                                            {{ message.content }}
                                            {% if message.property %}
                                                <br><small><i class="fas fa-home"></i> {{ message.property.title }}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Tab Activité -->
                        <div class="tab-pane" id="activity">
                            <div class="timeline timeline-inverse">
                                {% for notification in user.notifications|slice(0, 10) %}
                                    <div>
                                        <i class="fas fa-bell bg-info"></i>
                                        <div class="timeline-item">
                                            <span class="time">
                                                <i class="far fa-clock"></i> {{ notification.createdAt|date('d/m/Y H:i') }}
                                            </span>
                                            <h3 class="timeline-header">{{ notification.title }}</h3>
                                            <div class="timeline-body">
                                                {{ notification.message }}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                                <div>
                                    <i class="far fa-clock bg-gray"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_javascripts %}
    <script>
        $(document).ready(function() {
            // Activation/Désactivation utilisateur
            $('#activateUser, #deactivateUser').click(function() {
                const action = $(this).attr('id') === 'activateUser' ? 'activate' : 'deactivate';
                const message = action === 'activate' ? 'activer' : 'désactiver';

                if (confirm('Êtes-vous sûr de vouloir ' + message + ' cet utilisateur ?')) {
                    $.post('{{ path('admin_user_toggle_status') }}', {
                        id: {{ user.id }},
                        action: action,
                        _token: '{{ csrf_token('toggle_status') }}'
                    })
                        .done(function() {
                            location.reload();
                        })
                        .fail(function() {
                            alert('Une erreur est survenue');
                        });
                }
            });
        });
    </script>
{% endblock %}
